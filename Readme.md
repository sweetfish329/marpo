# Marp Online Collaborative Editor

React, Monaco Editor, Yjs, そして Go (Golang) を使用して構築する、Marp のためのオンライン共同編集アプリケーションです。

## 概要 (Overview)

このアプリケーションは、複数のユーザーがリアルタイムで Markdown スライドを共同編集できる Web アプリケーションです。編集内容は即座に他の共同編集者に同期され、Marp によるスライドプレビューもリアルタイムで更新されます。

さらに、Microsoft Word のように、特定のテキストに対してコメントや注釈を追加できる機能を備えることを目指します。

## 主な機能 (Features)

- **リアルタイム共同編集**: 複数のユーザーが同時に同じドキュメントを遅延なく編集できます。
- **カーソル位置の同期**: 他のユーザーのカーソル位置や選択範囲がリアルタイムで表示されます。
- **Marp リアルタイムプレビュー**: 編集中の Markdown が即座にスライドとしてプレビューされます。
- **コメント・注釈機能**: テキストの特定の位置にコメントを追加し、レビューやディスカッションを行えます。
- **堅牢なデータ同期**: CRDT (Conflict-free Replicated Data Type) アルゴリズムにより、同時編集によるデータの競合や破損を防ぎます。

## 技術スタック (Tech Stack)

本プロジェクトでは、実績のある既存ライブラリを最大限に活用し、安定性と開発効率を両立させます。

### フロントエンド

| 技術 | 役割 | ライブラリ/ツール |
| :--- | :--- | :--- |
| **UIフレームワーク** | コンポーネントベースのUI構築 | `React` |
| **テキストエディタ** | 高機能なMarkdownエディタ | `Monaco Editor` |
| **Marpプレビュー** | MarkdownからスライドHTMLへの変換 | `@marp-team/marp-core` |

### 共同編集 (Collaborative Editing)

| 技術 | 役割 | ライブラリ/ツール |
| :--- | :--- | :--- |
| **CRDT実装** | 競合のないデータ同期の実現 | `Yjs` |
| **エディタ連携** | Monaco EditorとYjsのバインディング | `y-monaco` |
| **通信プロトコル** | YjsとWebSocketサーバーの連携 | `y-websocket` |

### バックエンド

| 技術 | 役割 | ライブラリ/ツール |
| :--- | :--- | :--- |
| **サーバーサイド言語** | 高パフォーマンスなWebSocketサーバー | `Go (Golang)` |
| **リアルタイム通信** | クライアント-サーバー間の双方向通信 | `WebSocket` |
| **WebSocketライブラリ**| GoでのWebSocket実装 | `gorilla/websocket` or `nhooyr.io/websocket` |
| **データ永続化 (任意)** | ドキュメントデータの保存 | `PostgreSQL` / `Redis` |

## アーキテクチャ (Architecture)

クライアント（ブラウザ）は WebSocket を通じて Go で実装されたバックエンドサーバーに接続します。

```
[Client 1: Browser]                                [Client 2: Browser]
+-----------------------------------+              +-----------------------------------+
|         React Application         |              |         React Application         |
| +-------------------------------+ |              | +-------------------------------+ |
| | Monaco Editor <--(y-monaco)-->| |              | | Monaco Editor <--(y-monaco)-->| |
| +-------------------------------+ |              | +-------------------------------+ |
| | Y.js Document (CRDT)          | |              | | Y.js Document (CRDT)          | |
| +-------------------------------+ |              | +-------------------------------+ |
| | y-websocket-client            | |              | | y-websocket-client            | |
+-----------------------------------+              +-----------------------------------+
             ^                                                    ^
             | (WebSocket Connection)                             | (WebSocket Connection)
             v                                                    v
+-------------------------------------------------------------------------------------+
|                                 Backend Server (Go)                                 |
| +---------------------------------------------------------------------------------+ |
| |                             WebSocket Handler                                 | |
| | +---------------------------------------------------------------------------+ | |
| | | - Connection Management (Roomごとに管理)                                  | | |
| | | - Y.js Message Broadcasting (受け取ったメッセージを同Roomの他Clientへ)    | | |
| | +---------------------------------------------------------------------------+ | |
| +---------------------------------------------------------------------------------+ |
| | (Optional) Persistence Logic (DBへの保存/読込) e.g., PostgreSQL, Redis      | |
+-------------------------------------------------------------------------------------+
```

- **クライアント**: `y-websocket` ライブラリが Yjs ドキュメントの変更を検知し、差分データを WebSocket 経由でサーバーに送信します。
- **サーバー (Go)**: 特定のドキュメント（ルーム）に参加しているクライアントからメッセージを受信すると、そのメッセージを同じルームにいる他の全てのクライアントにブロードキャストします。サーバーは Yjs のメッセージ内容を解釈する必要はなく、単なる中継役（リレーサーバー）として機能します。

## プロジェクト構成 (Project Structure)

本プロジェクトは、バックエンドに Go を採用することから、Standard Go Project Layout に準拠したディレクトリ構成を採用します。これにより、コードの責務が明確になり、プロジェクトの見通しが良くなります。

```
.
├── cmd/
│   └── server/main.go      # WebSocketサーバーの起動ロジック
├── internal/
│   └── websocket/          # WebSocketのハンドラやルーム管理のロジック
└── web/
    └── ...                 # Reactフロントエンドのソースコード
```

## 主要機能の実装方針 (Implementation Details)

### コメント・注釈機能

この機能は Yjs と Monaco Editor の機能を組み合わせて実現します。

1.  **データ構造**: コメントのリストを `Y.Array<Y.Map>` として Yjs ドキュメント内で管理します。各コメントは `Y.Map` で表現され、コメント内容、投稿者、そして位置情報を含みます。
2.  **位置情報の保持**: テキストが編集されてもコメントの位置がずれないように、Yjs の **`RelativePosition`** を使用してテキスト内の相対位置を堅牢に保存します。
3.  **GUI**: React で Yjs のコメント用 `Y.Array` の変更を監視します。変更を検知したら、Monaco Editor の **`Decorations API`** を使用して、エディタの該当行にアイコンを表示したり、関連テキストをハイライトしたりします。

## 開発の進め方 (Development Roadmap)

1.  **環境構築**: React + Monaco Editor でスタンドアロンの Markdown エディタを作成する。
2.  **共同編集のプロトタイピング**: 公式の `y-websocket` (Node.js) サーバーを使い、フロントエンドの共同編集機能を先行して実装・検証する。
3.  **Go WebSocketサーバーの実装**: `y-websocket` の挙動を参考に、Go で独自の WebSocket リレーサーバーを実装し、Node.js サーバーと置き換える。
4.  **Marpプレビュー機能の実装**: エディタの変更を検知し、`@marp-team/marp-core` で HTML に変換してプレビュー表示する。
5.  **コメント機能の実装**: Yjs と Monaco Editor の API を連携させ、コメント機能を追加する。
6.  **永続化と認証**: ドキュメントの保存/読み込み機能や、必要に応じてユーザー認証機能を追加する。